@{
    ViewData["Title"] = "–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var client = ViewBag.Client as InsuranceAgency.Domain.Entities.Client;
    var verifications = ViewBag.Verifications as IEnumerable<InsuranceAgency.Domain.Entities.DocumentVerification>;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>üîç –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: @client?.FullName</h2>
        <p class="text-muted mb-0">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏</p>
    </div>
    <a href="@Url.Action("ClientHistory", "Agent", new { clientId = client?.Id })" class="btn btn-outline-secondary">‚Üê –ù–∞–∑–∞–¥</a>
</div>

<div class="row mt-3">
    <div class="col-md-12">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞</h5>
                    <small class="text-muted">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏: –§–ò–û –∏ –ü–∞—Å–ø–æ—Ä—Ç</small>
                </div>
                <span class="badge bg-warning text-dark">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–∞–Ω–Ω—ã–º –∏–∑ –õ–ö</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>–§–ò–û:</strong>
                        <div>@(string.IsNullOrWhiteSpace(client?.FullName) ? "-" : client.FullName)</div>
                    </div>
                    <div class="col-md-3">
                        <strong>Email:</strong>
                        <div>@(string.IsNullOrWhiteSpace(client?.Email) ? "-" : client.Email)</div>
                    </div>
                    <div class="col-md-3">
                        <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong>
                        <div>@(string.IsNullOrWhiteSpace(client?.Phone) ? "-" : client.Phone)</div>
                    </div>
                    <div class="col-md-3">
                        <strong>–ü–∞—Å–ø–æ—Ä—Ç:</strong>
                        <div>@(string.IsNullOrWhiteSpace(client?.Passport) ? "-" : client.Passport)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>–ù–æ–≤–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è</h5>
            </div>
            <div class="card-body">
                <form method="post" asp-action="VerifyDocuments" asp-controller="Agent" asp-route-clientId="@client?.Id" asp-antiforgery="true">
                    <div class="mb-3">
                        <label class="form-label">–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö <span class="text-danger">*</span></label>
                        <select name="documentType" class="form-select" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</option>
                            <option value="FullName">–§–ò–û (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ)</option>
                            <option value="Passport">–ü–∞—Å–ø–æ—Ä—Ç (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ)</option>
                            <option value="Phone">–¢–µ–ª–µ—Ñ–æ–Ω</option>
                            <option value="Email">Email</option>
                            <option value="Other">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ó–Ω–∞—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö <span class="text-danger">*</span></label>
                        <input type="text" name="documentNumber" class="form-control" required maxlength="100" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–∞—Å–ø–æ—Ä—Ç 1234 567890 –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" />
                        <small class="text-muted"> –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∫ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –∫–ª–∏–µ–Ω—Ç–∞.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                        <textarea name="notes" class="form-control" rows="3" maxlength="500" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">‚úÖ –°–æ–∑–¥–∞—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>–ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–π</h5>
            </div>
            <div class="card-body">
                @if (verifications != null && verifications.Any())
                {
                    <div class="list-group">
                        @foreach (var verification in verifications)
                        {
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">
                                            @(verification.DocumentType ?? "–ù–µ —É–∫–∞–∑–∞–Ω")
                                            @if (verification.VerifiedByAgentId == null)
                                            {
                                                <span class="badge bg-info ms-2">–ó–∞—è–≤–∫–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞</span>
                                            }
                                        </h6>
                                        <p class="mb-1">@(verification.DocumentNumber ?? "-")</p>
                                        @if (!string.IsNullOrWhiteSpace(verification.Notes))
                                        {
                                            <p class="mb-1 small text-muted">@verification.Notes</p>
                                        }
                                        <small>–°–æ–∑–¥–∞–Ω–æ: @verification.CreatedAt.ToString("dd.MM.yyyy HH:mm")</small>
                                        @if (verification.Status != InsuranceAgency.Domain.Enums.VerificationStatus.Pending)
                                        {
                                            <br><small>–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ: @verification.VerifiedAt.ToString("dd.MM.yyyy HH:mm")</small>
                                        }
                                    </div>
                                    <div>
                                        @if (verification.Status == InsuranceAgency.Domain.Enums.VerificationStatus.Pending)
                                        {
                                            <form method="post" asp-action="ApproveVerification" asp-controller="Agent" asp-route-id="@verification.Id" asp-antiforgery="true" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-success me-1" title="–û–¥–æ–±—Ä–∏—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é">
                                                    ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å
                                                </button>
                                            </form>
                                            <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#rejectVerificationModal@(verification.Id)" title="–û—Ç–∫–ª–æ–Ω–∏—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é">
                                                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                            </button>
                                            
                                            <!-- Modal –¥–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
                                            <div class="modal fade" id="rejectVerificationModal@(verification.Id)" tabindex="-1">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">–û—Ç–∫–ª–æ–Ω–∏—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                        </div>
                                                        <form method="post" asp-action="RejectVerification" asp-controller="Agent" asp-route-id="@verification.Id" asp-antiforgery="true">
                                                            <div class="modal-body">
                                                                <div class="mb-3">
                                                                    <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è <span class="text-danger">*</span></label>
                                                                    <textarea name="reason" class="form-control" rows="3" required placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏..."></textarea>
                                                                </div>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                                                                <button type="submit" class="btn btn-danger">–û—Ç–∫–ª–æ–Ω–∏—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é</button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                        else if (verification.Status == InsuranceAgency.Domain.Enums.VerificationStatus.Approved)
                                        {
                                            <span class="badge bg-success">–û–¥–æ–±—Ä–µ–Ω–æ</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
                }
            </div>
        </div>
    </div>
</div>


