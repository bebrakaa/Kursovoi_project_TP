@model IEnumerable<InsuranceAgency.Domain.Entities.Contract>
@{
    ViewData["Title"] = "–î–æ–≥–æ–≤–æ—Ä—ã —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>üìÑ –î–æ–≥–æ–≤–æ—Ä—ã —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è</h2>
        <p class="text-muted mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞–º–∏: —Å–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –ø–æ–∏—Å–∫ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è</p>
    </div>
    <div>
        <a href="@Url.Action("Index", "Dashboard")" class="btn btn-outline-secondary me-2">‚Üê –ù–∞–∑–∞–¥ –≤ –∫–∞–±–∏–Ω–µ—Ç</a>
        <a href="@Url.Action("Index", "Home")" class="btn btn-outline-primary me-2">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <a href="@Url.Action("CreateContract", "Agent")" class="btn btn-primary">
            <span>‚ûï</span> –°–æ–∑–¥–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä
        </a>
    </div>
</div>

<div class="mb-3">
    <form method="get" class="row g-3">
        <div class="col-md-6">
            <input type="text" name="search" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –¥–æ–≥–æ–≤–æ—Ä–∞..." value="@ViewBag.Search" />
        </div>
        <div class="col-md-4">
            <select name="status" class="form-select">
                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="Draft">–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
                <option value="Registered">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</option>
                <option value="PendingPayment">–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</option>
                <option value="Paid">–û–ø–ª–∞—á–µ–Ω</option>
                <option value="Active">–ê–∫—Ç–∏–≤–µ–Ω</option>
                <option value="Overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω</option>
                <option value="Suspended">–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</option>
                <option value="Cancelled">–û—Ç–º–µ–Ω—ë–Ω</option>
                <option value="Problematic">–ü—Ä–æ–±–ª–µ–º–Ω—ã–π</option>
                <option value="Expired">–ò—Å—Ç—ë–∫ —Å—Ä–æ–∫</option>
                <option value="Completed">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">–ü–æ–∏—Å–∫</button>
        </div>
    </form>
</div>

@if (Model != null && Model.Any())
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</th>
                    <th>–ö–ª–∏–µ–Ω—Ç</th>
                    <th>–£—Å–ª—É–≥–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è</th>
                    <th>–ü–µ—Ä–∏–æ–¥ –¥–µ–π—Å—Ç–≤–∏—è</th>
                    <th>–°—Ç—Ä–∞—Ö–æ–≤–∞—è –ø—Ä–µ–º–∏—è</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var contract in Model)
                {
                    <tr>
                        <td>
                            @if (string.IsNullOrWhiteSpace(contract.Number))
                            {
                                <span class="text-muted">–ù–µ –ø—Ä–∏—Å–≤–æ–µ–Ω</span>
                            }
                            else
                            {
                                <strong>@contract.Number</strong>
                            }
                        </td>
                        <td>@(contract.Client?.FullName ?? "<span class='text-muted'>–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</span>")</td>
                        <td>@(contract.Service?.Name ?? "<span class='text-muted'>–£—Å–ª—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</span>")</td>
                        <td>@contract.StartDate.ToString("dd.MM.yyyy") - @contract.EndDate.ToString("dd.MM.yyyy")</td>
                        <td><span class="badge bg-success">@contract.Premium.Amount.ToString("N2") @contract.Premium.Currency</span></td>
                        <td>
                            @{
                                var statusClass = contract.Status switch
                                {
                                    InsuranceAgency.Domain.Enums.ContractStatus.Draft => "bg-secondary",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Registered => "bg-info",
                                    InsuranceAgency.Domain.Enums.ContractStatus.PendingPayment => "bg-warning",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Paid => "bg-primary",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Active => "bg-success",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Overdue => "bg-danger",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Suspended => "bg-warning",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Cancelled => "bg-dark",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Problematic => "bg-danger",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Expired => "bg-secondary",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Completed => "bg-success",
                                    _ => "bg-secondary"
                                };
                            }
                            @{
                                var statusText = contract.Status switch
                                {
                                    InsuranceAgency.Domain.Enums.ContractStatus.Draft => "–ß–µ—Ä–Ω–æ–≤–∏–∫",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Registered => "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω",
                                    InsuranceAgency.Domain.Enums.ContractStatus.PendingPayment => "–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Paid => "–û–ø–ª–∞—á–µ–Ω",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Active => "–ê–∫—Ç–∏–≤–µ–Ω",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Overdue => "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Suspended => "–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Cancelled => "–û—Ç–º–µ–Ω—ë–Ω",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Problematic => "–ü—Ä–æ–±–ª–µ–º–Ω—ã–π",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Expired => "–ò—Å—Ç—ë–∫ —Å—Ä–æ–∫",
                                    InsuranceAgency.Domain.Enums.ContractStatus.Completed => "–ó–∞–≤–µ—Ä—à—ë–Ω",
                                    _ => contract.Status.ToString()
                                };
                            }
                            <span class="badge @statusClass">@statusText</span>
                        </td>
                        <td class="text-center">
                            @if (contract.Status == InsuranceAgency.Domain.Enums.ContractStatus.Draft)
                            {
                                <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#registerModal@(contract.Id)" title="–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä">
                                    ‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            
                            <!-- Modal –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
                            <div class="modal fade" id="registerModal@(contract.Id)" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <form method="post" asp-action="RegisterContract" asp-controller="Agent" asp-route-id="@contract.Id" asp-antiforgery="true">
                                            <div class="modal-body">
                                                <div class="mb-3">
                                                    <label class="form-label">–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞ <span class="text-danger">*</span></label>
                                                    <input type="text" name="number" class="form-control" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–ì-2025-001" maxlength="50" />
                                                    <small class="form-text text-muted">–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ —Å–∏—Å—Ç–µ–º–µ</small>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                                                <button type="submit" class="btn btn-success">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            }
                            else if (contract.Status == InsuranceAgency.Domain.Enums.ContractStatus.Paid)
                            {
                                <form method="post" asp-action="ActivateContract" asp-controller="Agent" asp-route-id="@contract.Id" asp-antiforgery="true" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-success" title="–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–æ–≥–æ–≤–æ—Ä –≤ —Å—Ç–∞—Ç—É—Å ¬´–ê–∫—Ç–∏–≤–µ–Ω¬ª (–§–ò–û –∏ –ø–∞—Å–ø–æ—Ä—Ç –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–¥–æ–±—Ä–µ–Ω—ã)"
                                            onclick="return confirm('–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–æ–≥–æ–≤–æ—Ä –≤ —Å—Ç–∞—Ç—É—Å ¬´–ê–∫—Ç–∏–≤–µ–Ω¬ª? –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –§–ò–û –∏ –ø–∞—Å–ø–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–∞ –æ–¥–æ–±—Ä–µ–Ω—ã.');">
                                        ‚ö° –°–¥–µ–ª–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–º
                                    </button>
                                </form>
                            }
                            else if (contract.Status == InsuranceAgency.Domain.Enums.ContractStatus.Active)
                            {
                                <span class="badge bg-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                            }
                    </td>
                </tr>
            }
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info">
        <h5>üìÑ –î–æ–≥–æ–≤–æ—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h5>
        <p class="mb-0">–ù–∞—á–Ω–∏—Ç–µ —Å —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–°–æ–∑–¥–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä" –≤—ã—à–µ.</p>
    </div>
}

